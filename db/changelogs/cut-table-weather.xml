<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
    http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd ">
    
    <changeSet id="3" author="weathermanager">
        <dropColumn tableName="weather">
            <column name="sunrise" />
            <column name="sunset" />
            <column name="moonrise" />
            <column name="moonset" />
            <column name="moon_phase" />
            <column name="moon_illumination" />
        </dropColumn>
        <rollback>
            <addColumn tableName="weather">
                <column name="sunrise" type="time" />
                <column name="sunset" type="time" />
                <column name="moonrise" type="time" />
                <column name="moonset" type="time" />
                <column name="moon_phase" type="char(14)" />
                <column name="moon_illumination" type="int" />
            </addColumn>
            <sql dbms="postgresql">
                UPDATE weather AS w
                SET sunrise = a.sunrise,
                    sunset = a.sunset,
                    moonrise = a.moonrise,
                    moonset = a.moonset,
                    moon_phase = a.moon_phase,
                    moon_illumination = a.moon_illumination
                FROM astro AS a 
                WHERE w.weather_id = a.weather_id;
            </sql>
            <sql dbms="mysql">
                UPDATE weather AS w, astro AS a 
                SET w.sunrise = a.sunrise,
                    w.sunset = a.sunset,
                    w.moonrise = a.moonrise,
                    w.moonset = a.moonset,
                    w.moon_phase = a.moon_phase,
                    w.moon_illumination = a.moon_illumination
                WHERE w.weather_id = a.weather_id;
            </sql>
            <sql>
                TRUNCATE TABLE astro;
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>